import random
from pwn import process, remote
from myTubes import MyTube
from math import gcd
import string
from sys import argv
# Refer to the writeup for understanding
# What the name of the variables stands for


#p = process("python3 challenge.py", shell=True)
HOST = argv[1] if len(argv) > 1 else "localhost"
PORT = argv[2] if len(argv) > 2 else 10200
p = remote(HOST, PORT)
t = MyTube(p)


def random_string(length: int):
    return ''.join(random.choice(string.ascii_letters) for _ in range(length))


def choose(choice: int):
    t.rec("> ")
    t.sendInt(choice)


def find_a_value(yseq: list[int], m: int):
    for i in range(1, len(yseq)):
        try:
            a = yseq[i] * pow(yseq[i-1], -1, m) % m
            return a
        except Exception:
            continue
    
    raise Exception("Unable to calculate the value of a :(")

def find_c_value(xseq: list[int], a: int, m: int):
    assert len(xseq) > 1
    return (xseq[1] - a*xseq[0]) % m    

xseq = []
for _ in range(16):
    choose(1)
    t.rec("Username: ") and t.send(random_string(16))
    t.rec("Password: ") and t.send(random_string(16))
    token = t.rec(bounds=(": ", "\n"))
    xseq.append(int(token))

yseq = [xseq[i] - xseq[i-1] for i in range(1, len(xseq))]
tseq = [yseq[i]**2 - yseq[i-1]*yseq[i+1] for i in range(1, len(yseq) - 1)]

m = gcd(*tseq)
a = find_a_value(yseq, m)
c = find_c_value(xseq, a, m)    

admin_token = (xseq[0] - c) * pow(a, -1, m) % m
newpassword = "foo"
choose(3)
t.rec("Username: ") and t.send("admin")
t.rec("Token: ") and t.sendInt(admin_token)
t.rec("Give me the new password: ") and t.send(newpassword)

choose(2)
t.rec("Username: ") and t.send("admin")
t.rec("Password: ") and t.send(newpassword)

p.interactive()
